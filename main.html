<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Examen general ‚Äî Biolog√≠a (C√©lulas)</title>
<style>
  :root{
    --bg:#ffffff;
    --card:#ffffff;
    --text:#0f1724;
    --muted:#6b7280;
    --accent:#2b6cb0;
    --correct:#1f9d55;
    --wrong:#e55353;
    --shadow: 0 8px 30px rgba(16,24,40,0.06);
  }
  #startNow {background:var(--accent);color:rgb(255, 255, 255);border:grey;padding:10px 12px;border-radius:8px;cursor:pointer}
  [data-theme="dark"]{
    --bg:#132b5b;
    --card:#071025;
    --text:#e6eef8;
    --muted:#98a2b3;
    --accent:#7aa7ff;
    --shadow: 0 8px 30px rgba(0,0,0,0.6);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg) 0%, rgba(255,255,255,0.02) 100%);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
  .app{width:100%;max-width:900px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
  header h1{margin:0;font-size:1.2rem;color:var(--accent)}
  header .controls{display:flex;gap:8px;align-items:center}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow)}
  .intro{margin-bottom:12px;color:var(--muted)}
  .exam-area{margin-top:12px}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px}
  .meta .counter{color:var(--muted)}
  .box{background:rgba(0,0,0,0.02);padding:12px;border-radius:10px}
  .definition{font-size:1.05rem;font-weight:600;margin-bottom:10px}
  .answer-row{display:flex;gap:8px;align-items:center}
  input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid #e6edf9;background:transparent;color:var(--text);font-size:1rem}
  button{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;background:var(--accent);color:white}
  .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted)}
  .feedback{margin-top:10px;font-weight:700;min-height:22px}
  .feedback.correct{color:var(--correct)}
  .feedback.wrong{color:var(--wrong)}
  .final-score{font-size:1.1rem;font-weight:800;color:var(--accent);margin-top:12px}
  .review{margin-top:12px}
  .review-item{padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);margin-bottom:8px;background:rgba(0,0,0,0.01)}
  .small{font-size:0.9rem;color:var(--muted)}
  .flex{display:flex;gap:8px;align-items:center}
  .actions{display:flex;gap:8px;margin-top:12px}
  .toggle{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;background:rgba(0,0,0,0.03);cursor:pointer}
  @media (max-width:640px){
    input[type="text"]{font-size:0.95rem}
    header{flex-direction:column;align-items:flex-start;gap:8px}
  }
</style>
</head>
<body>
  <div class="app card" id="app">
    <header>
      <div>
        <h1>Examen final ‚Äî C√©lulas (definici√≥n ‚Üí palabra)</h1>
        <div class="small intro">20 preguntas aleatorias. Escribe la palabra que corresponde a la definici√≥n. Respuestas sin distinguir may√∫sculas, min√∫sculas ni tildes.</div>
      </div>
      <div class="controls">
        <div class="toggle" id="themeToggle" title="Alternar modo oscuro">üåô <span class="small">Modo</span></div>
        <button id="startBtn">Comenzar examen</button>
      </div>
    </header>

    <section id="startPanel" class="card" style="margin-bottom:12px">
      <p class="small">Al hacer clic en <strong>Comenzar examen</strong> se generar√°n 20 preguntas aleatorias. Podr√°s escribir la respuesta y recibir feedback inmediato. Al final ver√°s tu nota y un repaso de errores.</p>
      <div class="actions">
        <label class="small" style="align-self:center">N√∫mero de preguntas:</label>
        <select id="numSelect" style="padding:8px;border-radius:8px;border:1px solid #e6edf9">
          <option value="10">10</option>
          <option value="15">15</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
        </select>
        <button id="startNow" class="btn-ghost">Comenzar ahora</button>
      </div>
    </section>

    <section id="examPanel" class="card" style="display:none">
      <div class="meta">
        <div class="counter"><span id="qIndex">0</span> / <span id="qTotal">0</span></div>
        <div class="small">Puntuaci√≥n: <span id="score">0</span></div>
      </div>

      <div class="box">
        <div class="definition" id="definitionText">‚Äî</div>
        <div class="answer-row">
          <input type="text" id="answerInput" placeholder="Escribe tu respuesta aqu√≠ y pulsa Enter o Comprobar">
          <button id="checkBtn">Comprobar</button>
          <button id="skipBtn" class="btn-ghost">Saltar</button>
        </div>
        <div class="feedback" id="feedback"></div>
      </div>

      <div class="actions" style="justify-content:flex-end">
        <button id="prevQ" class="btn-ghost">Anterior</button>
        <button id="nextQ" class="btn-ghost">Siguiente</button>
        <button id="finishBtn" style="background:#444;color:#fff">Finalizar examen</button>
      </div>

      <div id="finalBlock" style="display:none">
        <div class="final-score" id="finalScoreText"></div>
        <div class="small" id="gradeText"></div>
        <div class="review" id="reviewList"></div>
        <div style="margin-top:12px" class="flex">
          <button id="retryBtn">Volver a intentar</button>
          <button id="downloadBtn" class="btn-ghost">Descargar resultados (CSV)</button>
        </div>
      </div>
    </section>

  </div>

<script>
/* ---------- Banco de definiciones + respuestas ---------- */
/* Mezcla de Mitosis, Meiosis, Org√°nulos y Teor√≠a Endosimbi√≥tica */
const definitionBank = [
  {def: "Etapa del ciclo celular en la que la cromatina comienza a condensarse.", ans: "profase"},
  {def: "Estructura que desaparece al inicio de la profase (en el n√∫cleo).", ans: "nucl√©olo"},
  {def: "Estructura proteica que separa las crom√°tidas durante la anafase.", ans: "microt√∫bulos del huso"},
  {def: "Plano imaginario donde se alinean los cromosomas durante la metafase.", ans: "placa metaf√°sica"},
  {def: "Nombre del proceso que divide el citoplasma despu√©s de la mitosis.", ans: "citocinesis"},
  {def: "Anillo formado por filamentos de actina que divide a la c√©lula animal en dos.", ans: "anillo contr√°ctil"},
  {def: "Fase de la mitosis en la que las crom√°tidas se separan y van a polos opuestos.", ans: "anafase"},
  {def: "Fase de la mitosis en la que reaparece la membrana nuclear y los cromosomas se descondensan.", ans: "telofase"},
  {def: "Nombre del proceso que produce cuatro c√©lulas haploides a partir de una c√©lula diploide.", ans: "meiosis"},
  {def: "Fase de la meiosis en la cual tiene lugar el sobrecruzamiento (crossing-over).", ans: "profase i"},
  {def: "Tipo de divisi√≥n que reduce a la mitad el n√∫mero de cromosomas.", ans: "divisi√≥n reductora"},
  {def: "Nombre de la c√©lula resultante de la uni√≥n de dos gametos.", ans: "cigoto"},
  {def: "Org√°nulo encargado de la producci√≥n de energ√≠a mediante respiraci√≥n celular.", ans: "mitocondria"},
  {def: "Org√°nulo vegetal que contiene tilacoides y realiza la fotos√≠ntesis.", ans: "cloroplasto"},
  {def: "Org√°nulo sin membrana que sintetiza prote√≠nas.", ans: "ribosoma"},
  {def: "Conjunto l√≠quido del interior celular donde est√°n flotando los org√°nulos.", ans: "citoplasma"},
  {def: "Org√°nulo que procesa y empaqueta prote√≠nas en ves√≠culas para su secreci√≥n.", ans: "aparato de golgi"},
  {def: "Ret√≠culo endoplasm√°tico con ribosomas que sintetiza prote√≠nas destinadas a la secreci√≥n.", ans: "ret√≠culo endoplasm√°tico rugoso"},
  {def: "Ret√≠culo endoplasm√°tico que sintetiza l√≠pidos y detoxifica sustancias.", ans: "ret√≠culo endoplasm√°tico liso"},
  {def: "Estructura que protege y mantiene la forma de las c√©lulas vegetales (compuesta por celulosa).", ans: "pared celular"},
  {def: "Peque√±as estructuras que ayudan a la movilidad bacteriana (cola m√≥vil).", ans: "flagelo"},
  {def: "Estructura bacteriana que facilita la adhesi√≥n al sustrato (no siempre presente).", ans: "fimbrias"},
  {def: "Estructura presente en algunas bacterias que confiere protecci√≥n adicional y virulencia.", ans: "c√°psula"},
  {def: "Teor√≠a que propone que las mitocondrias y cloroplastos proceden de bacterias integradas en c√©lulas primitivas.", ans: "teor√≠a endosimbi√≥tica"},
  {def: "Prueba de la teor√≠a endosimbi√≥tica: mitocondrias y cloroplastos contienen este tipo de ADN.", ans: "adn circular"},
  {def: "Nombre del tipo de c√©lula que no tiene n√∫cleo definido.", ans: "procariota"},
  {def: "Tipo de c√©lula que contiene n√∫cleo y org√°nulos membranosos.", ans: "eucariota"},
  {def: "Org√°nulo que contiene enzimas digestivas y realiza la digesti√≥n intracelular.", ans: "lisosoma"},
  {def: "Estructura que mantiene la forma celular y participa en el movimiento celular (compuesta de filamentos proteicos).", ans: "citoesqueleto"},
  {def: "Estructura a partir de la cual se forman los cilios y flagelos y que participa en la divisi√≥n celular en animales.", ans: "centriolo"},
  {def: "Proceso de muerte celular programada que elimina c√©lulas con da√±o gen√©tico.", ans: "apoptosis"},
  {def: "Prote√≠na conocida como guardi√°n del genoma que controla la apoptosis y la detenci√≥n del ciclo celular.", ans: "p53"},
  {def: "Nombre de la fase del ciclo celular en la que la c√©lula replica su ADN.", ans: "fase s"},
  {def: "Nombre general del conjunto de procesos que van desde el nacimiento de la c√©lula hasta su divisi√≥n.", ans: "ciclo celular"},
  {def: "Mol√©culas formadas por la uni√≥n de nucle√≥tidos que almacenan y transmiten la informaci√≥n gen√©tica.", ans: "√°cidos nucleicos"},
  {def: "Unidad estructural de los √°cidos nucleicos formada por fosfato, pentosa y base nitrogenada.", ans: "nucle√≥tido"},
  {def: "Tipo de enlace que une los nucle√≥tidos entre s√≠ en los √°cidos nucleicos.", ans: "enlace fosfodi√©ster"},
  {def: "√Åcido nucleico de doble cadena que contiene la informaci√≥n gen√©tica en la mayor√≠a de los organismos.", ans: "adn"},
  {def: "√Åcido nucleico de cadena sencilla que participa en la s√≠ntesis de prote√≠nas.", ans: "arn"},
  {def: "Mol√©cula de ARN que copia la informaci√≥n del ADN y la lleva al ribosoma.", ans: "arn mensajero"},
  {def: "Tipo de ARN que forma parte estructural de los ribosomas.", ans: "arn ribos√≥mico"},
  {def: "Tipo de ARN que transporta amino√°cidos hasta el ribosoma durante la traducci√≥n.", ans: "arn de transferencia"},
  {def: "Proceso mediante el cual el ADN se copia a s√≠ mismo antes de la divisi√≥n celular.", ans: "replicaci√≥n"},
  {def: "Tipo de replicaci√≥n del ADN en la que se conserva una cadena original y se sintetiza otra nueva.", ans: "replicaci√≥n semiconservativa"},
  {def: "Proceso mediante el cual la informaci√≥n del ADN se copia en una mol√©cula de ARN mensajero.", ans: "transcripci√≥n"},
  {def: "Proceso mediante el cual se sintetizan prote√≠nas a partir de la informaci√≥n del ARN mensajero.", ans: "traducci√≥n"},
  {def: "Conjunto de procesos que permiten obtener una prote√≠na a partir de la informaci√≥n de un gen.", ans: "expresi√≥n g√©nica"},
  {def: "Relaci√≥n entre las bases nitrogenadas del ARNm y los amino√°cidos que codifican.", ans: "c√≥digo gen√©tico"},
  {def: "Triplete de bases nitrogenadas que codifica un amino√°cido espec√≠fico.", ans: "cod√≥n"},
  {def: "Mutaci√≥n debida a errores naturales en los mecanismos celulares.", ans: "mutaci√≥n espont√°nea"},
  {def: "Mutaci√≥n provocada por la acci√≥n de agentes externos como radiaci√≥n o sustancias qu√≠micas.", ans: "mutaci√≥n inducida"},
  {def: "Sustancia f√≠sica, qu√≠mica o biol√≥gica capaz de provocar mutaciones.", ans: "mut√°geno"},
  {def: "Mutaci√≥n que afecta a la secuencia de nucle√≥tidos de un gen.", ans: "mutaci√≥n g√©nica"},
  {def: "Mutaci√≥n que altera la estructura de un cromosoma.", ans: "mutaci√≥n cromos√≥mica"},
  {def: "Mutaci√≥n que altera el n√∫mero de cromosomas en una c√©lula.", ans: "mutaci√≥n gen√≥mica"},
  {def: "Tipo de mutaci√≥n en la que se gana o pierde uno o m√°s cromosomas, como en el s√≠ndrome de Down.", ans: "aneuploid√≠a"},
  {def: "Tipo de mutaci√≥n en la que se altera la dotaci√≥n completa de cromosomas (n, 3n, 4n...).", ans: "euploid√≠a"},
  {def: "Mutaci√≥n que afecta a las c√©lulas del cuerpo y no se transmite a la descendencia.", ans: "mutaci√≥n som√°tica"},
  {def: "Mutaci√≥n que afecta a los gametos y puede transmitirse a la descendencia.", ans: "mutaci√≥n germinal"},
  {def: "Mutaci√≥n sin efectos apreciables sobre el organismo.", ans: "mutaci√≥n neutral"},
  {def: "Mutaci√≥n que confiere una ventaja al organismo.", ans: "mutaci√≥n beneficiosa"},
  {def: "Mutaci√≥n que produce un efecto negativo en el organismo.", ans: "mutaci√≥n perjudicial"},
  {def: "Trastorno gen√©tico causado por la presencia de una tercera copia del cromosoma 21.", ans: "s√≠ndrome de down"},
  {def: "Trastorno gen√©tico que afecta a hombres con un cromosoma X adicional (XXY).", ans: "s√≠ndrome de klinefelter"},
  {def: "Trastorno gen√©tico que afecta a mujeres que solo tienen un cromosoma X.", ans: "s√≠ndrome de turner"},
  {def: "Nombre del proceso por el que un virus con ARN convierte su material gen√©tico en ADN para infectar.", ans: "transcripci√≥n inversa"},
  {def: "Mol√©culas proteicas capaces de replicarse a s√≠ mismas y causar enfermedades neurodegenerativas.", ans: "priones"},
  {def: "Estructura en doble h√©lice descubierta por Watson y Crick a partir de los estudios de Rosalind Franklin.", ans: "estructura del adn"},
  {def: "Tipo de enlace que une las bases complementarias en el ADN.", ans: "enlace de hidr√≥geno"},
  {def: "Bases nitrogenadas que se aparean mediante tres enlaces de hidr√≥geno.", ans: "citosina y guanina"},
  {def: "Bases nitrogenadas que se aparean mediante dos enlaces de hidr√≥geno.", ans: "adenina y timina"},
  {def: "Mol√©cula que contiene la informaci√≥n necesaria para sintetizar una prote√≠na espec√≠fica.", ans: "gen"}

];

/* ---------- Utilidades ---------- */
/* Quitar acentos, normalizar y min√∫sculas */
function normalizeAnswer(s){
  if(!s) return "";
  // Normalizar acentos y pasar a min√∫sculas
  try {
    return s.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
  } catch(e) {
    // formato alternativo si normalize no disponible
    return s.replace(/[√°√†√§√£√¢√Å√Ä√Ñ√É√Ç]/g,'a').replace(/[√©√®√´√™√â√à√ã√ä]/g,'e').replace(/[√≠√¨√Ø√Æ√ç√å√è√é]/g,'i').replace(/[√≥√≤√∂√µ√¥√ì√í√ñ√ï√î]/g,'o').replace(/[√∫√π√º√ª√ö√ô√ú√õ]/g,'u').toLowerCase().trim();
  }
}

/* Comparar permitiendo sin√≥nimos simples:
   - si la respuesta correcta es compuesta (p.ej. "ret√≠culo endoplasm√°tico rugoso")
     aceptaremos si el usuario escribe "rer" o "reticulo rugoso" etc. Haremos comprobaci√≥n b√°sica: 
     si todas las palabras clave del answer aparecen en la respuesta del usuario (orden libre).
*/
function isEquivalent(user, correct){
  const u = normalizeAnswer(user);
  const c = normalizeAnswer(correct);
  if(!u) return false;
  if(u === c) return true;
  // split into words and check keywords
  const cWords = c.split(/\s+/).filter(Boolean);
  // if correct is one word, allow small fuzzy matches
  if(cWords.length === 1){
    // allow near exact or substring match
    if(u.includes(cWords[0])) return true;
  } else {
    // require at least 60% of words present
    let matched = 0;
    cWords.forEach(w => { if(u.includes(w)) matched++; });
    if(matched / cWords.length >= 0.6) return true;
  }
  return false;
}

/* ---------- Estado y UI ---------- */
const startBtn = document.getElementById('startBtn');
const startNow = document.getElementById('startNow');
const numSelect = document.getElementById('numSelect');
const examPanel = document.getElementById('examPanel');
const startPanel = document.getElementById('startPanel');
const qIndexSpan = document.getElementById('qIndex');
const qTotalSpan = document.getElementById('qTotal');
const definitionText = document.getElementById('definitionText');
const answerInput = document.getElementById('answerInput');
const checkBtn = document.getElementById('checkBtn');
const skipBtn = document.getElementById('skipBtn');
const prevQ = document.getElementById('prevQ');
const nextQ = document.getElementById('nextQ');
const scoreSpan = document.getElementById('score');
const feedbackDiv = document.getElementById('feedback');
const finishBtn = document.getElementById('finishBtn');
const finalBlock = document.getElementById('finalBlock');
const finalScoreText = document.getElementById('finalScoreText');
const gradeText = document.getElementById('gradeText');
const reviewList = document.getElementById('reviewList');
const retryBtn = document.getElementById('retryBtn');
const downloadBtn = document.getElementById('downloadBtn');
const themeToggle = document.getElementById('themeToggle');

let examQuestions = []; // {def, ans, user, correct(bool)}
let currentIndex = 0;
let score = 0;

/* ---------- L√≥gica del examen ---------- */
function pickRandomQuestions(n){
  // shuffle and pick n
  const pool = [...definitionBank];
  for(let i=pool.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [pool[i], pool[j]] = [pool[j], pool[i]];
  }
  return pool.slice(0, Math.min(n, pool.length)).map(item => ({...item, user: null, correct: null}));
}

function startExam(){
  const n = parseInt(numSelect.value,10) || 20;
  examQuestions = pickRandomQuestions(n);
  currentIndex = 0;
  score = 0;
  updateMeta();
  showQuestion(0);
  startPanel.style.display = 'none';
  examPanel.style.display = 'block';
  finalBlock.style.display = 'none';
  answerInput.value = '';
  feedbackDiv.textContent = '';
  answerInput.focus();
}

function updateMeta(){
  qIndexSpan.textContent = currentIndex+1;
  qTotalSpan.textContent = examQuestions.length;
  scoreSpan.textContent = score;
}

function showQuestion(i){
  if(i<0) i = 0;
  if(i>=examQuestions.length) i = examQuestions.length-1;
  currentIndex = i;
  const q = examQuestions[currentIndex];
  definitionText.textContent = q.def;
  answerInput.value = q.user || '';
  feedbackDiv.textContent = '';
  feedbackDiv.className = 'feedback';
  updateMeta();
  answerInput.focus();
}

/* Comprobar respuesta actual */
function checkAnswer(){
  const q = examQuestions[currentIndex];
  const user = answerInput.value.trim();
  if(user === ''){
    feedbackDiv.textContent = 'Escribe una respuesta o pulsa "Saltar".';
    feedbackDiv.className = 'feedback wrong';
    return;
  }
  const ok = isEquivalent(user, q.ans);
  q.user = user;
  q.correct = ok;
  if(ok){
    feedbackDiv.textContent = '¬°Correcto!';
    feedbackDiv.className = 'feedback correct';
    // si antes no estaba contestada correctamente, sumar
    // pero para evitar doble conteo: recalcular puntuaci√≥n
  } else {
    feedbackDiv.textContent = `Incorrecto ‚Äî respuesta correcta: ${q.ans}`;
    feedbackDiv.className = 'feedback wrong';
  }
  // recalcular puntuaci√≥n
  score = examQuestions.reduce((acc, it) => acc + (it.correct ? 1 : 0), 0);
  updateMeta();
}

/* Saltar pregunta (la deja sin responder) */
function skipQuestion(){
  const q = examQuestions[currentIndex];
  if(q.user === null){
    q.user = '';
    q.correct = false;
  }
  // mover a la siguiente autom√°ticamente
  if(currentIndex < examQuestions.length-1) showQuestion(currentIndex+1);
  else showQuestion(currentIndex);
}

/* Navegaci√≥n */
prevQ.addEventListener('click', ()=> { if(currentIndex>0) showQuestion(currentIndex-1); });
nextQ.addEventListener('click', ()=> { if(currentIndex<examQuestions.length-1) showQuestion(currentIndex+1); });

checkBtn.addEventListener('click', ()=> { checkAnswer(); });
skipBtn.addEventListener('click', ()=> { skipQuestion(); });

answerInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') { e.preventDefault(); checkAnswer(); }
});

/* Finalizar examen: mostrar nota y repaso */
function finishExam(){
  // ensure answers counted
  // mark unanswered as incorrect
  examQuestions.forEach(q => { if(q.user === null){ q.user = ''; q.correct = false; } });
  score = examQuestions.reduce((acc,it)=> acc + (it.correct ? 1 : 0), 0);
  updateMeta();
  // show final block
  finalBlock.style.display = 'block';
  finalScoreText.textContent = `Resultado: ${score} / ${examQuestions.length}`;
  // grade out of 10
  const nota = (score / examQuestions.length) * 10;
  gradeText.textContent = `Nota: ${nota.toFixed(1)} / 10`;
  // build review
  reviewList.innerHTML = '';
  examQuestions.forEach((q, idx) => {
    const item = document.createElement('div');
    item.className = 'review-item';
    const status = q.correct ? '‚úî Correcto' : '‚úñ Incorrecto';
    item.innerHTML = `<strong>${idx+1}.</strong> ${q.def}<br>
      <small class="small">Tu respuesta: <em>${q.user || '‚Äî'}</em> ‚Ä¢ Correcta: <em>${q.ans}</em></small>
      <div style="margin-top:6px;color:${q.correct ? 'var(--correct)' : 'var(--wrong)'};font-weight:700">${status}</div>`;
    reviewList.appendChild(item);
  });
  // scroll to final block
  finalBlock.scrollIntoView({behavior:'smooth'});
}

/* Reset / reintentar */
function retryExam(){
  startPanel.style.display = 'block';
  examPanel.style.display = 'none';
  finalBlock.style.display = 'none';
  examQuestions = [];
  currentIndex = 0;
  score = 0;
  qIndexSpan.textContent = '0';
  qTotalSpan.textContent = '0';
}

/* Descargar CSV */
function downloadResults(){
  const rows = [];
  rows.push(['#','Definici√≥n','Tu respuesta','Correcta','Estado']);
  examQuestions.forEach((q, idx) => {
    rows.push([idx+1, q.def, q.user || '', q.ans, q.correct ? 'Correcto' : 'Incorrecto']);
  });
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'examen_resultados.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* Tema (modo oscuro) toggle */
(function(){
  const html = document.documentElement;
  const saved = localStorage.getItem('biologia-theme');
  if(saved === 'dark') html.setAttribute('data-theme','dark');
  themeToggle.addEventListener('click', ()=>{
    if(html.getAttribute('data-theme') === 'dark'){ html.removeAttribute('data-theme'); localStorage.setItem('biologia-theme','light'); }
    else { html.setAttribute('data-theme','dark'); localStorage.setItem('biologia-theme','dark'); }
  });
})();

/* Eventos botones */
startNow.addEventListener('click', startExam);
startBtn.addEventListener('click', () => { window.scrollTo({top:0,behavior:'smooth'}); startPanel.scrollIntoView({behavior:'smooth'}); });
finishBtn.addEventListener('click', finishExam);
retryBtn.addEventListener('click', retryExam);
downloadBtn.addEventListener('click', downloadResults);

/* Prev/Next navigation with keyboard */
document.addEventListener('keydown', (e)=>{
  if(examPanel.style.display === 'none') return;
  if(e.key === 'ArrowLeft') prevQ.click();
  if(e.key === 'ArrowRight') nextQ.click();
});

/* Inicial: mostrar contadores en 0 */
qIndexSpan.textContent = '0';
qTotalSpan.textContent = '0';
scoreSpan.textContent = '0';

</script>
</body>
</html>
